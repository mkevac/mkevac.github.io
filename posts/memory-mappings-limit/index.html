<!DOCTYPE html>
<html><meta charset="utf-8"><meta name="generator" content="Hugo 0.62.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light only">
<meta name="supported-color-schemes" content="light only"><title>Memory Mappings Limit&nbsp;&ndash;&nbsp;Marko Kevac Home</title><link rel="stylesheet" href="/css/core.min.e73ac0eb5b16f1aefed3b353b34abf9dc9f9f6735546de1acb941912359128d168e55170e061dbdecb707feac1457f4d.css" integrity="sha384-5zrA61sW8a7&#43;07NTs0q/ncn59nNVRt4ay5QZEjWRKNFo5VFw4GHb3stwf&#43;rBRX9N"><body>
<div class="base-body max-width"><section id="header" class="header max-body-width"><p><a class="home" href="/"><span class="site-name">Marko Kevac Home</span></a></p></section><div id="content" class="flex-body max-body-width"><section class="article-header">
<h1>Memory Mappings Limit</h1>
<p class="article-date">2016-06-12</p>
</section>
<article class="markdown-body"><p>We have some very strange memory corruption problem in one of our daemons. As one of the many approaches to find the bug, we have built and pushed to production this daemon, but without <a href="http://jemalloc.net/"target="_blank">jemalloc</a>, memory allocator library that we use in all our projects.</p>
<p>Few hours after the release monitoring team reported an unusal amount of errors returned from the system. It happens that few percent of the requests returned &ldquo;out of memory&rdquo; error. It was strange because there were a lot of a memory available in the system.</p>
<p>Output of a <a href="http://man7.org/linux/man-pages/man1/strace.1.html"target="_blank">strace</a> utility showed that <a href="http://man7.org/linux/man-pages/man2/mprotect.2.html"target="_blank">mprotect()</a> call that we use to install a guard page for a coroutines stack returns an error:</p>
<pre><code>strace -emprotect -ttt -T -p 25754 -c

1438269965.801936 mmap(NULL, 69632, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f73baf9c000 &lt;0.000092&gt;
1438269965.802065 mprotect(0x7f73baf9c000, 4096, PROT_NONE) = -1 ENOMEM (Cannot allocate memory) &lt;0.000005&gt;
</code></pre><p>First we thought that this could not happen because <a href="http://man7.org/linux/man-pages/man2/mmap.2.html"target="_blank">mmap</a> returned without an error and that something is wrong with the kernel we are using. Especially because this particular machine have very old kernel</p>
<pre><code># uname -a
Linux cppbig31 3.0.82-0.7.99-default #1 SMP Thu Jun 27 13:19:18 UTC 2013 (6efde93) x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p>But brief googling and kernel source gave us a much more simple answer: memory mappings limit. mmap() call creates a map, mprotect() can split one mapping into two. And we have a lot of these calls.</p>
<pre><code>root@cppbig31.ulan:~# cat /proc/25754/maps | wc -l
65523
root@cppbig31.ulan:~# cat /proc/sys/vm/max_map_count
65530
</code></pre><p>libc memory allocator seems to be another source of a maps because similar daemon with jemalloc doesn't use so much mappings:</p>
<pre><code># cat /proc/5667/maps | wc -l
1938
</code></pre><p>This is how one can increase the limit:</p>
<pre><code>echo &quot;655300&quot; &gt; /proc/sys/vm/max_map_count
</code></pre></article><section class="article-navigation"><p><a class="link" href="/posts/ssh-exchange-identification/"><span class="li"></span>ssh_exchange_identification connection reset by peer problem</a></p></section></div><section id="footer" class="footer max-body-width"><p>Marko Kevac Home</p>
<p><span>Powered by </span><a href="https://gohugo.io">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/">Notepadium</a></p>
</section></div>
</body>
</html>