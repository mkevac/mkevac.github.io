<!DOCTYPE html>
<html><meta charset="utf-8"><meta name="generator" content="Hugo 0.62.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light only">
<meta name="supported-color-schemes" content="light only"><title>ssh_exchange_identification connection reset by peer problem&nbsp;&ndash;&nbsp;Marko Kevac Home</title><link rel="stylesheet" href="/css/core.min.d9711af52b4a9f03cadf855745b58b99b11663ee0cd05b260696b78838016d0481c779fec0944c9dd9763b9560cd88c6.css" integrity="sha384-2XEa9StKnwPK34VXRbWLmbEWY&#43;4M0FsmBpa3iDgBbQSBx3n&#43;wJRMndl2O5VgzYjG"><body>
<div class="base-body max-width"><section id="header" class="header max-body-width"><p><a class="home" href="/"><span class="site-name">Marko Kevac Home</span></a></p></section><div id="content" class="flex-body max-body-width"><section class="article-header">
<h1>ssh_exchange_identification connection reset by peer problem</h1>
<p class="article-date">2016-09-22</p>
</section>
<article class="markdown-body"><p>At <a href="https://badoo.com"target="_blank">Badoo</a> we have a distributed system that uses ssh on start to connect to each node and exchange some data.</p>
<p>Sometimes I've seen ssh fail with error</p>
<pre><code>ssh_exchange_identification: read: Connection reset by peer error
</code></pre><p>Usually, If you see this error, it means that server didn't like your certificate or you were banned from accessing this server.</p>
<p>The best way to debug this problem is to append <code>-vvv</code> while executing ssh client to increase verbosity and to do the same on server.</p>
<p>If your Linux distribution uses systemd, then the best way to look into sshd logs is <code>journalctl -f</code> command or specifically <code>journalctl -u sshd.service -f</code> command.</p>
<p>To increase ssd verbosity, edit <code>/etc/ssh/sshd_config</code> and add <code>LogLevel DEBUG3</code> and then restart sshd with command <code>sudo systemctl restart ssd.service</code>.</p>
<p>Unfortunately, logs didn't show anything useful for me.</p>
<p>But I had a hunch that it is somehow connected to the fact that our distributed system makes a lot of ssh connections and very rapidly.</p>
<p>While browsing trough <code>sshd_config</code> man page I've found config variable that could be to blame. And I was right.</p>
<p>If you happen to have the same problem I did, try increasing <code>MaxStartups</code> variable and restarting sshd service.</p>
<p>I've increased it to 100:30:600 from default 10:30:60 and connection resets vanished.</p>
<p>It is unfortunate that ssh and sshd logs gave me no clue about the problem.</p>
</article><section class="article-navigation"><p><a class="link" href="/posts/new-blog/"><span class="li"></span>New Blog (Hello World)</a></p><p><a class="link" href="/posts/memory-mappings-limit/"><span class="li"></span>Memory Mappings Limit</a class="link"></p></section></div><section id="footer" class="footer max-body-width"><p>Marko Kevac Home</p>
<p><span>Powered by </span><a href="https://gohugo.io">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/">Notepadium</a></p>
</section><script src="/js/hljs.min.0799348a91dce12c6be4a73f943cfe78f181f4e6f6ec35c4af0fca1de377879f77cfab03c30f03a174d675737b5a9314.js" integrity="sha384-B5k0ipHc4Sxr5Kc/lDz&#43;ePGB9Ob27DXErw/KHeN3h593z6sDww8DoXTWdXN7WpMU"></script><script>hljs.initHighlightingOnLoad();</script></div>
</body>
</html>